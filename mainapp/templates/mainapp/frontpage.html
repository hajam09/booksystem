{% extends "mainapp/base.html" %}
{% load static %}
<style type="text/css">
    .carousel {
        width:640px;
        height:360px;
    }
    h4:hover {
        cursor: pointer;
    }
</style>
{% block content %}
<!-- Start of Image Carousel & Search -->
<div class="container">

	<form class="col-xl-12" id="searchForm">
        {% csrf_token %}
		<div class="input-group col-md-12">
			<input style="  font-size: 15px !important;" type="text" name="booksearch" class="form-control input-lg" placeholder="Search for book"/>
			<span class="input-group-btn">
				<button style="background-color: white; border-style:none; border-left: solid 1px #ccc;" class="btn btn-info btn-lg" type="submit" onclick="makeSearch();return false;">
					<i style="color:black;" class="glyphicon glyphicon-search"></i>
				</button>
			</span>
		</div>
	</form>
    <div id="myCarousel" class="carousel slide" data-ride="carousel">
        <!-- Indicators -->
        <ol class="carousel-indicators">
            <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
            <li data-target="#myCarousel" data-slide-to="1"></li>
            <li data-target="#myCarousel" data-slide-to="2"></li>
            <li data-target="#myCarousel" data-slide-to="3"></li>
        </ol>

        <!-- Wrapper for slides -->
        <div class="carousel-inner">
            <div class="item active">
                <img src="{% static 'assets/library1.jpg' %}" alt="Library Image">
            </div>

            <div class="item">
                <img src="{% static 'assets/library2.jpg' %}" alt="Library Image">
            </div>

            <div class="item">
                <img src="{% static 'assets/library3.jpg' %}" alt="Library Image">
            </div>

            <div class="item">
                <img src="{% static 'assets/library4.jpg' %}" alt="Library Image">
            </div>
		</div>

        <!-- Left and right controls -->
        <a class="left carousel-control" href="#myCarousel" data-slide="prev">
            <span class="glyphicon glyphicon-chevron-left"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="right carousel-control" href="#myCarousel" data-slide="next">
            <span class="glyphicon glyphicon-chevron-right"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
</div>
<div class="container">
    <div>
        <ul class="list-group list-group-flush" id="searchresult"></ul>
    </div>
</div>
<!-- End of Image Carousel & Search -->
<hr>
<!-- Recently added books carousel -->
<div class="container">
    <!-- <h1>Recently Added Books!</h1> -->
    <p style="font-weight:bold; color: grey; font-size: 20px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recently Added Books...</p>

    <!--  <a href="https://github.com/rtpHarry/Bootstrap3-ShowManySlideOneCarousel">this code sample</a>   -->
    <div class="row">
        <div class="col-md-12">
            <div class="carousel carousel-showmanymoveone slide" id="carousel-tilenav_1" data-interval="false">
                <div class="carousel-inner">
                    {% for books in recently_added_books %}
                        <div class="item">
                            <div class="col-xs-12 col-sm-6 col-md-2">
                                <a style="cursor: pointer;" onclick="goToBookPage('{{books.isbn_13}}')"><p class="lead img-responsive"><img src={{books.thumbnail}} alt="No Image" style="width:100%; display: inline-block; height: 200px;"></p><p>{{books.title}}</p></a>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="item active">
                        <!-- <div class="col-xs-12 col-sm-6 col-md-2">
                            <a href="#"><img src="http://placehold.it/500/0054A6/fff/&amp;text=1" class="img-responsive"></a>
                        </div> -->
                    </div>
                </div>
                <a class="left carousel-control" href="#carousel-tilenav_1" data-slide="prev"><i class="glyphicon glyphicon-chevron-left"></i></a>
                <a class="right carousel-control" href="#carousel-tilenav_1" data-slide="next"><i class="glyphicon glyphicon-chevron-right"></i></a>
            </div>
        </div>
    </div>
</div>
<hr>
<!-- average_rating_recommendation books carousel -->
<div class="container">
    <p style="font-weight:bold; color: grey; font-size: 20px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Books Based on Ratings...</p>

    <!--  <a href="https://github.com/rtpHarry/Bootstrap3-ShowManySlideOneCarousel">this code sample</a>   -->
    <div class="row">
        <div class="col-md-12">
            <div class="carousel carousel-showmanymoveone slide" id="carousel-tilenav_2" data-interval="false">
                <div class="carousel-inner">
                    {% for books in average_rating_recommendation %}
                        <div class="item">
                            <div class="col-xs-12 col-sm-6 col-md-2">
                                <a style="cursor: pointer;" onclick="goToBookPage('{{books.isbn_13}}')"><p class="lead img-responsive"><img src={{books.thumbnail}} alt="No Image" style="width:100%; display: inline-block; height: 200px;"></p><p>{{books.title}}</p></a>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="item active">
                        <!-- <div class="col-xs-12 col-sm-6 col-md-2">
                            <a href="#"><img src="http://placehold.it/500/0054A6/fff/&amp;text=1" class="img-responsive"></a>
                        </div> -->
                    </div>
                </div>
                <a class="left carousel-control" href="#carousel-tilenav_2" data-slide="prev"><i class="glyphicon glyphicon-chevron-left"></i></a>
                <a class="right carousel-control" href="#carousel-tilenav_2" data-slide="next"><i class="glyphicon glyphicon-chevron-right"></i></a>
            </div>
        </div>
    </div>
</div>
<hr>
<!-- other_user_favourite_books books carousel -->
{% if user.is_authenticated %}
    {% if other_user_favourite_books %}
        <div class="container">
            <p style="font-weight:bold; color: grey; font-size: 20px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Favourite books from similar users'...</p>

            <!--  <a href="https://github.com/rtpHarry/Bootstrap3-ShowManySlideOneCarousel">this code sample</a>   -->
            <div class="row">
                <div class="col-md-12">
                    <div class="carousel carousel-showmanymoveone slide" id="carousel-tilenav_3" data-interval="false">
                        <div class="carousel-inner">
                            {% for books in other_user_favourite_books %}
                                <div class="item">
                                    <div class="col-xs-12 col-sm-6 col-md-2">
                                        <a style="cursor: pointer;" onclick="goToBookPage('{{books.isbn_13}}')"><p class="lead img-responsive"><img src={{books.thumbnail}} alt="No Image" style="width:100%; display: inline-block; height: 200px;"></p><p>{{books.title}}</p></a>
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="item active">
                                <!-- <div class="col-xs-12 col-sm-6 col-md-2">
                                    <a href="#"><img src="http://placehold.it/500/0054A6/fff/&amp;text=1" class="img-responsive"></a>
                                </div> -->
                            </div>
                        </div>
                        <a class="left carousel-control" href="#carousel-tilenav_3" data-slide="prev"><i class="glyphicon glyphicon-chevron-left"></i></a>
                        <a class="right carousel-control" href="#carousel-tilenav_3" data-slide="next"><i class="glyphicon glyphicon-chevron-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endif %}
<script type="text/javascript">
    (function() {
        $('.carousel-showmanymoveone .item').each(function() {
            var itemToClone = $(this);

            for (var i = 1; i < 6; i++) {
                itemToClone = itemToClone.next();

                // wrap around if at end of item collection
                if (!itemToClone.length) {
                    itemToClone = $(this).siblings(':first');
                }

                // grab item, clone, add marker class, add to collection
                itemToClone.children(':first-child').clone()
                .addClass("cloneditem-" + (i))
                .appendTo($(this));
            }
        });
    }());
    // if (window.performance && window.performance.navigation.type == window.performance.navigation.TYPE_BACK_FORWARD) {
        //only display when user goes form book page to front page of some backpage to frontpage.html
    //     "{% if recent_search %}"
    //         var elem = document.querySelector('#myCarousel');
    //         if(elem) {
    //             elem.parentNode.removeChild(elem);
    //         }
    //         "{% for results in recent_search %}"
    //             var uid = "{{results.id}}";
    //             var thumbnail = "{{results.thumbnail}}";
    //             var isbn_13 = "{{results.isbn_13}}";
    //             var isbn_10 = "{{results.isbn_10}}";
    //             var volumeinfo = "{{results.title}}";
    //             var authors = "{{results.authors}}";
    //             var ratingsCount = "{{results.ratingsCount}}";
    //             var averageRating = "{{results.averageRating}}";

    //             var checkElement = document.getElementById(uid);
    //             if (!checkElement) {
    //                 $("#searchresult").append('<div class="row" id=' + uid + '><br><div class="col-sm-2"><img alt="" src=' + thumbnail + ' style="height: 150px; width: 150px" /></div><div class="col-sm-8"><h4><a style="cursor: pointer;" onclick="goToBookPage('+isbn_13+','+isbn_10+')">' + volumeinfo + '</a></h4><p> Authors:' + authors + '</p><p>' + ratingsCount + ' ratings, '+averageRating+' average rating</p></div></div>');
    //             }
    //         "{% endfor %}"
    //     "{% endif %}"
    // }

    "{% if recent_search %}"
        var elem = document.querySelector('#myCarousel');
        if(elem) {
            elem.parentNode.removeChild(elem);
        }
        "{% for results in recent_search %}"
            var uid = "{{results.id}}";
            var thumbnail = "{{results.thumbnail}}";
            var isbn_13 = "{{results.isbn_13}}";
            var isbn_10 = "{{results.isbn_10}}";
            var volumeinfo = "{{results.title}}";
            var authors = "{{results.authors}}";
            var ratingsCount = "{{results.ratingsCount}}";
            var averageRating = "{{results.averageRating}}";

            var checkElement = document.getElementById(uid);
            if (!checkElement) {
                $("#searchresult").append('<div class="row" id=' + uid + '><br><div class="col-sm-2"><img alt="" src=' + thumbnail + ' style="height: 150px; width: 150px" /></div><div class="col-sm-8"><h4><a style="cursor: pointer;" onclick="goToBookPage('+isbn_13+')">' + volumeinfo + '</a></h4><p> Authors:' + authors + '</p><p>' + ratingsCount + ' ratings, '+averageRating+' average rating</p></div></div>');
            }
        "{% endfor %}"
    "{% endif %}"

    function searchByISBN(isbn) {

        var result = []
        var makerequest = "https://www.googleapis.com/books/v1/volumes?q=isbn:"+isbn;

        $.get(makerequest, function(response) {
            for (var i = 0; i<response.items.length; i++) {
                result.push();
            }
        });
    }

    function makeSearch() {
        var list = document.getElementById("searchresult");
        while (list.hasChildNodes()) {
            list.removeChild(list.firstChild);
        }
        var booksearch = document.getElementsByName("booksearch")[0].value;
        var makerequest = "https://www.googleapis.com/books/v1/volumes?q="+booksearch;//+":keyes&key=AIzaSyALnLIg8cf5Z6SdBIX5HzP5i-qKYmwyUiA";

        var all_books = [];

        $.get(makerequest, function(response) {
            console.log(response.items);
            var elem = document.querySelector('#myCarousel');
            if(elem) {
                elem.parentNode.removeChild(elem);
            }
            try {
                for (var i = 0; i<response.items.length; i++) {
                    try {
                        //Required Attributes
                        var uid = response.items[i].id;
                        var etag = response.items[i].etag;
                        var volumeinfo = response.items[i].volumeInfo.title;
                        var authors = response.items[i].volumeInfo.authors;
                        var averageRating = response.items[i].volumeInfo.averageRating;
                        var ratingsCount = response.items[i].volumeInfo.ratingsCount;
                        var thumbnail = response.items[i].volumeInfo.imageLinks.thumbnail;
                        var categories = response.items[i].volumeInfo.categories;
                        var isbn_13 = null;
                        var isbn_10 = null;

                        if (response.items[i].volumeInfo.industryIdentifiers[0].type == "ISBN_10") {
                            isbn_10 = response.items[i].volumeInfo.industryIdentifiers[0].identifier;
                        } else if (response.items[i].volumeInfo.industryIdentifiers[0].type == "ISBN_13") {
                            isbn_13 = response.items[i].volumeInfo.industryIdentifiers[0].identifier;
                        }

                        if (response.items[i].volumeInfo.industryIdentifiers[1].type == "ISBN_10") {
                            isbn_10 = response.items[i].volumeInfo.industryIdentifiers[1].identifier;
                        } else if(response.items[i].volumeInfo.industryIdentifiers[1].type == "ISBN_13") {
                            isbn_13 = response.items[i].volumeInfo.industryIdentifiers[1].identifier;
                        }
                        var description = response.items[i].volumeInfo.description;
                        console.log(isbn_13,authors);
                        
                        var industryIdentifiers = response.items[i].volumeInfo.industryIdentifiers;
                        if(industryIdentifiers.length==2) {
                            if(!ratingsCount) {
                                ratingsCount = 0;
                            }
                            if(!averageRating) {
                                averageRating = 0.0
                            }

                            averageRating = averageRating.toFixed(1)

                            var checkElement = document.getElementById(uid);

                            if (!checkElement) {
                                $("#searchresult").append('<div class="row" id=' + uid + '><br><div class="col-sm-2"><img alt="" src=' + thumbnail + ' style="height: 150px; width: 150px" /></div><div class="col-sm-8"><h4><a style="cursor: pointer;" onclick="goToBookPage('+isbn_13+')">' + volumeinfo + '</a></h4><p> Authors:' + authors + '</p><p>' + ratingsCount + ' ratings, '+averageRating+' average rating</p></div></div>');
                            }
                            all_books.push(response.items[i]);
                        }
                    }
                    catch(err){
                        console.log("No result found");
                    }
                }
            } catch {
                $("#searchresult").append('<p style="left: 0; line-height: 200px; margin-top: -100px; position: absolute; text-align: center; top: 50%; width: 100%; font-weight: 900;">Sorry, we could\'t find any results matching "'+booksearch+'"</p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>');
            }

            //Send to server to create a model for the book and add to csv
            $.ajax({
                type: "POST",
                data: {
                    book: JSON.stringify(all_books)
                },
                success: function() {
                    console.log("DONE");
                }
            })

        });
    }

    var goToBookPage = function(isbn_13) {
        console.log(isbn_13, "Inside goToBookPage function");
        window.location.href = "book_page/"+isbn_13+"/";
    }
</script>
{% endblock %}