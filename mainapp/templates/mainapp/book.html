{% extends "mainapp/base.html" %}
{% load static %}
<!--https://www.bootdey.com/snippets/view/product-full-detail-->
<link rel="stylesheet" type="text/css" href="{% static 'css/book.css' %}"/>
{% block content %}
<div class="container">
    <div class="col-sm-12 col-md-12 col-lg-12">
        <!-- product -->
        <div class="product-content product-wrap clearfix product-deatil">
            <div class="row">
                <div class="col-md-5 col-sm-12 col-xs-12 ">
                    <div class="product-image">
                        <img src="{{thumbnail}}" alt="No Image" style="min-width: 250px; min-height: 250px; padding: 13px; display: inline-block;">
                    </div>
                </div>
                <div class="col-md-7 col-sm-12 col-xs-12">
                	<h2 class="name">
                		{{title}} by <a href="http://www.google.com/search?q={{authors}}">{{authors}}</a><br>
                			<div id="star-rating">
                			</div>
						</h2>
                    <hr>
                    <h3 class="price-container">
							<button class="btn btn-white btn-default" id="add-to-favourites"><i class="fa fa-star"></i> Add to Favourites </button>
                            <button class="btn btn-white btn-default" id="reading-now"><i class="fa fa-envelope"></i> Reading Now</button>
							<button class="btn btn-white btn-default" id="to-read"><i class="fa fa-envelope"></i> I need to read this</button>
                            <button class="btn btn-white btn-default" id="have-read"><i class="fa fa-envelope"></i> I have read this</button>
						</h3>
                    
                    <hr>
                    <div class="description description-tabs">
                        <ul id="myTab" class="nav nav-pills">
                            <li class="active"><a href="#more-information" data-toggle="tab" class="no-margin">Book Description </a></li>
                            <li class=""><a href="#specifications" data-toggle="tab">Specifications</a></li>
                            <li class=""><a href="#reviews" data-toggle="tab">Reviews</a></li>
                        </ul>
                        <div id="myTabContent" class="tab-content">
                            <div class="tab-pane fade active in" id="more-information">
                                <br>
                                <strong>Description Title</strong>
                                <p>{{description}}</p>
                            </div>
                            <div class="tab-pane fade" id="specifications">
                                <br>
                                <dl class="">
                                    <dt>Author</dt>
                                    <dd>{{authors}}</dd>
                                    <br>

                                    <dt>Publisher</dt>
                                    <dd>{{publisher}}</dd>
                                    <br>

                                    <dt>Genre</dt>
                                    <dd>{{categories}}</dd>
                                    <br>

                                    <dt>Published Date</dt>
                                    <dd>{{publishedDate}}</dd>
                                </dl>
                            </div>
                            <div class="tab-pane fade" id="reviews">
                                <br>
                                <form method="post" class="well padding-bottom-10" onsubmit="return false;">
                                    {% csrf_token %}
                                    <textarea rows="3" class="form-control" placeholder="Write a review" id="user_review"></textarea>
                                    <div class="margin-top-10">
                                        <button type="submit" class="btn btn-sm btn-primary pull-right" onclick="postReview();return false;">
                                            Submit Review
                                        </button>
                                        <a href="javascript:void(0);" class="btn btn-link profile-link-btn" rel="tooltip" data-placement="bottom" title="" data-original-title="Add Location"><i class="fa fa-location-arrow"></i></a>
                                        <a href="javascript:void(0);" class="btn btn-link profile-link-btn" rel="tooltip" data-placement="bottom" title="" data-original-title="Add Voice"><i class="fa fa-microphone"></i></a>
                                        <a href="javascript:void(0);" class="btn btn-link profile-link-btn" rel="tooltip" data-placement="bottom" title="" data-original-title="Add Photo"><i class="fa fa-camera"></i></a>
                                        <a href="javascript:void(0);" class="btn btn-link profile-link-btn" rel="tooltip" data-placement="bottom" title="" data-original-title="Add File"><i class="fa fa-file"></i></a>
                                    </div>
                                </form>

                                <div class="chat-body no-padding profile-message">
                                    <ul id="reviews-list">
                                        <!-- <li class="message">
                                            <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="online">
                                            <span class="message-text"> 
													<a href="javascript:void(0);" class="username">
														Alisha Molly 
														<span class="badge">Purchase Verified</span>
                                            <span class="pull-right">
															<i class="fa fa-star fa-2x text-primary"></i>
															<i class="fa fa-star fa-2x text-primary"></i>
															<i class="fa fa-star fa-2x text-primary"></i>
															<i class="fa fa-star fa-2x text-primary"></i>
															<i class="fa fa-star fa-2x text-muted"></i>
														</span>
                                            </a>
                                            Can't divide were divide fish forth fish to. Was can't form the, living life grass darkness very image let unto fowl isn't in blessed fill life yielding above all moved
                                            </span>
                                            <ul class="list-inline font-xs">
                                                <li>
                                                    <a href="javascript:void(0);" class="text-info"><i class="fa fa-thumbs-up"></i> This was helpful (22)</a>
                                                </li>
                                                <li class="pull-right">
                                                    <small class="text-muted pull-right ultra-light"> Posted 1 year ago </small>
                                                </li>
                                            </ul>
                                        </li> -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!-- <div class="row">
                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <a href="javascript:void(0);" class="btn btn-success btn-lg">Add to cart ($129.54)</a>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <div class="btn-group pull-right">
                                <button class="btn btn-white btn-default"><i class="fa fa-star"></i> Add to wishlist </button>
                                <button class="btn btn-white btn-default"><i class="fa fa-envelope"></i> Contact Seller</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
            <!-- <p>Horizon similar items place location</p> -->
            <!-- https://bootsnipp.com/snippets/zDQkr -->
            <div class="row">
                <div class="MultiCarousel" data-items="1,3,5,6" data-slide="1" id="MultiCarousel"  data-interval="1000">
                    <div class="MultiCarousel-inner">
                    </div>
                    <button class="btn btn-primary leftLst"><</button>
                    <button class="btn btn-primary rightLst">></button>
                </div>
            </div>
        </div>
        <!-- end product -->
    </div>
</div>
<script type="text/javascript">
    function postReview() {
        var user_review = document.getElementById("user_review").value;

        $.ajax({
            type: "POST",
            data: {
                functionality: 'create-review',
                isbn_13: "{{isbn_13}}",
                isbn_10: "{{isbn_10}}",
                user_review: user_review,
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(message) {
                if(message=="not_authenticated") {
                    var url = "{% url 'mainapp:login' %}";
                    document.location.href = url;
                }
                
                if (message.split("&nbsp;")[0]=="revew_created_successfully") {
                    var review_data = message.split("&nbsp;");
                    var user_full_name = review_data[1];
                    var review_message = review_data[2];
                    var creation_date = review_data[3];

                    var no_review_element = document.getElementById("no-review");
                    if(no_review_element) {
                        no_review_element.remove();
                    }

                    $("#reviews-list").append('<li class="message"><img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="online"><span class="message-text"><a href="javascript:void(0);" class="username"> '+user_full_name+' <span class="pull-right"><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-muted"></i></span></a>'+review_message+'</span><ul class="list-inline font-xs"><li><a href="javascript:void(0);" class="text-info"><i class="fa fa-thumbs-up"></i> This was helpful (22)</a></li><li class="pull-right"><small class="text-muted pull-right ultra-light"> Posted at: '+creation_date+'</small></li></ul></li>');
                }
            }
        })
    }

    //Code for Carousel for showing similar items
    //$(document).ready(function() {
    function carousel_books() {
        var itemsMainDiv = ('.MultiCarousel');
        var itemsDiv = ('.MultiCarousel-inner');
        var itemWidth = "";

        $('.leftLst, .rightLst').click(function() {
            var condition = $(this).hasClass("leftLst");
            if (condition) {click(0, this);}
            else {click(1, this);}
        });

        ResCarouselSize();
        $(window).resize(function() {
            ResCarouselSize();
        });

        //this function define the size of the items
        function ResCarouselSize() {
            var incno = 0;
            var dataItems = ("data-items");
            var itemClass = ('.item');
            var id = 0;
            var btnParentSb = '';
            var itemsSplit = '';
            var sampwidth = $(itemsMainDiv).width();
            var bodyWidth = $('body').width();

            $(itemsDiv).each(function() {
                id = id + 1;
                var itemNumbers = $(this).find(itemClass).length;
                btnParentSb = $(this).parent().attr(dataItems);
                itemsSplit = btnParentSb.split(',');

                $(this).parent().attr("id", "MultiCarousel" + id);
                if (bodyWidth >= 1200) {
                    incno = itemsSplit[3];
                    itemWidth = sampwidth / incno;
                } else if (bodyWidth >= 992) {
                    incno = itemsSplit[2];
                    itemWidth = sampwidth / incno;
                } else if (bodyWidth >= 768) {
                    incno = itemsSplit[1];
                    itemWidth = sampwidth / incno;
                } else {
                    incno = itemsSplit[0];
                    itemWidth = sampwidth / incno;
                }

                $(this).css({
                    'transform': 'translateX(0px)',
                    'width': itemWidth * itemNumbers
                });
                $(this).find(itemClass).each(function() {
                    $(this).outerWidth(itemWidth);
                });

                $(".leftLst").addClass("over");
                $(".rightLst").removeClass("over");
            });
        }

        //this function used to move the items
        function ResCarousel(e, el, s) {
            var leftBtn = ('.leftLst');
            var rightBtn = ('.rightLst');
            var translateXval = '';
            var divStyle = $(el + ' ' + itemsDiv).css('transform');
            var values = divStyle.match(/-?[\d\.]+/g);
            var xds = Math.abs(values[4]);
            if (e == 0) {
                translateXval = parseInt(xds) - parseInt(itemWidth * s);
                $(el + ' ' + rightBtn).removeClass("over");

                if (translateXval <= itemWidth / 2) {
                    translateXval = 0;
                    $(el + ' ' + leftBtn).addClass("over");
                }
            } else if (e == 1) {
                var itemsCondition = $(el).find(itemsDiv).width() - $(el).width();
                translateXval = parseInt(xds) + parseInt(itemWidth * s);
                $(el + ' ' + leftBtn).removeClass("over");

                if (translateXval >= itemsCondition - itemWidth / 2) {
                    translateXval = itemsCondition;
                    $(el + ' ' + rightBtn).addClass("over");
                }
            }

            $(el + ' ' + itemsDiv).css('transform', 'translateX(' + -translateXval + 'px)');
        }

        //It is used to get some elements from btn
        function click(ell, ee) {
            var Parent = "#" + $(ee).parent().attr("id");
            var slide = $(Parent).attr("data-slide");
            ResCarousel(ell, Parent, slide);
        }
    };
    //});

    //End of code

	window.onload = function() {
		//Need to code so that averageRating variable is not decimal and dounder to nearest integer
		var averageRating = "{{averageRating}}";
		//console.log(averageRating);
		for (var i = 0; i < averageRating; i++) {
			$('#star-rating').append('<i class="fa fa-star fa-2x text-primary">&nbsp;&nbsp;</i>');
		}
		//console.log(i);
		if (i!=5) {
			for (var j = i; j < 5; j++) {
				$('#star-rating').append('<i class="fa fa-star fa-2x text-muted"></i>');
			}
		}
        
		$('#star-rating').append('<span class="fa fa-2x"><h5>&nbsp;&nbsp;({{ratingsCount}}) Votes</h5></span>');
		$('#star-rating').append('<a href="javascript:void(0);">&nbsp;&nbsp;{{book_reviews|length}} customer reviews</a>');

        var in_favourite_books = "{{in_favourite_Book}}";
        var in_reading_books = "{{in_reading_Book}}";
        var in_to_read_books = "{{in_to_read_Book}}";
        var in_have_read_books = "{{in_have_read_Book}}";

        if (in_favourite_books=="True") {
            document.getElementById("add-to-favourites").style.background="#24ad52";
        }
        else {
            document.getElementById("add-to-favourites").style.background="#ffffff";
        }

        if (in_reading_books=="True") {
            document.getElementById("reading-now").style.background="#24ad52";
        }
        else {
            document.getElementById("reading-now").style.background="#ffffff";
        }

        if (in_to_read_books=="True") {
            document.getElementById("to-read").style.background="#24ad52";
        }
        else {
            document.getElementById("to-read").style.background="#ffffff";
        }

        if (in_have_read_books=="True") {
            document.getElementById("have-read").style.background="#24ad52";
        }
        else {
            document.getElementById("have-read").style.background="#ffffff";
        }

        if ("{{book_reviews|length}}"==0) {
            //No reviews exists for this book.
            $("#reviews-list").append("<p id='no-review'>No reviews has been made for this item!</p>");
        } else {
            "{% for reviews in book_reviews %}"
                var user_full_name = "{{reviews.customerID.userid.first_name}} {{reviews.customerID.userid.last_name}}"
                $("#reviews-list").append('<li class="message"><img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="online"><span class="message-text"><a href="javascript:void(0);" class="username"> '+user_full_name+' <span class="pull-right"><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-primary"></i><i class="fa fa-star fa-2x text-muted"></i></span></a>{{reviews.description}}</span><ul class="list-inline font-xs"><li><a href="javascript:void(0);" class="text-info"><i class="fa fa-thumbs-up"></i> This was helpful (22)</a></li><li class="pull-right"><small class="text-muted pull-right ultra-light"> Posted at: {{reviews.created_at}} </small></li></ul></li>');
            "{% endfor %}"
        }

        "{% for reviews in book_reviews %}"
            //console.log("#############", "{{reviews}}", "{{reviews.bookID}}");
        "{% endfor %}"

        "{% for books in item_based_recommendation %}"
            var isbn_13 = "{{books.isbn_13}}";
            var isbn_10 = "{{books.isbn_10}}";

            $(".MultiCarousel-inner").append('<div class="item"><div class="pad15"><a style="cursor: pointer;" onclick="bookPage('+isbn_13+','+isbn_10+')"><p class="lead"><img src="{{books.thumbnail}}" alt="No Image" style="width:100%; display: inline-block;"</p><p>{{books.title}}</p></a></div></div>');

        "{% endfor %}"

        carousel_books();

	}

    var isbn_13 = "{{isbn_13}}";
    var isbn_10 = "{{isbn_10}}";

    $('#add-to-favourites').click(function() {
        $.ajax({
            type: "PUT",
            data: {
                functionality: 'add-to-favourites',
                isbn_13: "{{isbn_13}}",
                isbn_10: "{{isbn_10}}",
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(message) {
                if(message=="new_object") {
                    document.getElementById("add-to-favourites").style.background="#24ad52";
                }
                if(message=="remove_object") {
                    document.getElementById("add-to-favourites").style.background="#ffffff";
                }
                if(message=="not_authenticated") {
                    var url = "{% url 'mainapp:login' %}";
                    document.location.href = url;
                }
            }
        })
    });

    $('#reading-now').click(function() {
        console.log("reading-now clicked");

        $.ajax({
            type: "PUT",
            data: {
                functionality: 'reading-now',
                isbn_13: "{{isbn_13}}",
                isbn_10: "{{isbn_10}}",
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(message) {
                if(message=="new_object") {
                    document.getElementById("reading-now").style.background="#24ad52";
                }
                if(message=="remove_object") {
                    document.getElementById("reading-now").style.background="#ffffff";
                }
                if(message=="not_authenticated") {
                    var url = "{% url 'mainapp:login' %}";
                    document.location.href = url;
                }
            }
        })
    });

    $('#to-read').click(function() {
        console.log("to-read clicked");

        $.ajax({
            type: "PUT",
            data: {
                functionality: 'to-read',
                isbn_13: "{{isbn_13}}",
                isbn_10: "{{isbn_10}}",
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(message) {
                if(message=="new_object") {
                    document.getElementById("to-read").style.background="#24ad52";
                }
                if(message=="remove_object") {
                    document.getElementById("to-read").style.background="#ffffff";
                }
                if(message=="not_authenticated") {
                    var url = "{% url 'mainapp:login' %}";
                    document.location.href = url;
                }
            }
        })
    });

    $('#have-read').click(function() {
        console.log("have-read clicked");

        $.ajax({
            type: "PUT",
            data: {
                functionality: 'have-read',
                isbn_13: "{{isbn_13}}",
                isbn_10: "{{isbn_10}}",
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(message) {
                if(message=="new_object") {
                    document.getElementById("have-read").style.background="#24ad52";
                }
                if(message=="remove_object") {
                    document.getElementById("have-read").style.background="#ffffff";
                }
                if(message=="not_authenticated") {
                    var url = "{% url 'mainapp:login' %}";
                    document.location.href = url;
                }
            }
        })
    });

var bookPage = function(isbn_13, isbn_10) {
        var current_URL = window.location.href;
        current_URL = current_URL.split("/");
        current_URL = current_URL.slice(0, 3);
        current_URL[1]="//";
        current_URL = current_URL.join("");
        window.location = current_URL+"/book_page/"+isbn_13+"/"+isbn_10;
    }
</script>
{% endblock %}